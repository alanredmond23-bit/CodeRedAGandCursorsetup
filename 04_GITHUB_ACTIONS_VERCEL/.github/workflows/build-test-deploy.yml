name: Build | Test | Deploy Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # BUILD JOB
  # ============================================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for analysis
      
      - name: Detect language
        id: detect
        run: |
          if [ -f "package.json" ]; then echo "language=javascript" >> $GITHUB_OUTPUT; fi
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then echo "language=python" >> $GITHUB_OUTPUT; fi
          if [ -f "go.mod" ]; then echo "language=go" >> $GITHUB_OUTPUT; fi
      
      # JavaScript/Node build
      - name: Setup Node.js
        if: steps.detect.outputs.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies (Node)
        if: steps.detect.outputs.language == 'javascript'
        run: npm ci
      
      - name: Build (Node)
        if: steps.detect.outputs.language == 'javascript'
        run: npm run build
        continue-on-error: true
      
      - name: Check bundle size
        if: steps.detect.outputs.language == 'javascript'
        run: |
          if [ -d "dist" ]; then
            SIZE=$(du -sh dist | cut -f1)
            echo "ðŸ“¦ Bundle size: $SIZE"
          fi
      
      # Python build
      - name: Setup Python
        if: steps.detect.outputs.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies (Python)
        if: steps.detect.outputs.language == 'python'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build (Python)
        if: steps.detect.outputs.language == 'python'
        run: python setup.py build
        continue-on-error: true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 5
  
  # ============================================================================
  # CODE QUALITY JOB
  # ============================================================================
  quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || true
      
      - name: Run ESLint
        run: npm run lint || true
        continue-on-error: true
      
      - name: Run Prettier check
        run: npm run format:check || true
        continue-on-error: true
      
      - name: Run TypeScript check
        run: npm run type-check || true
        continue-on-error: true
      
      - name: Security audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: Upload quality results
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          retention-days: 5
  
  # ============================================================================
  # TEST JOB
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 45
    strategy:
      matrix:
        test-type: ['unit', 'integration']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || true
      
      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: npm run test:unit -- --coverage
        continue-on-error: true
      
      - name: Run integration tests
        if: matrix.test-type == 'integration'
        run: npm run test:integration || true
        continue-on-error: true
      
      - name: Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false
      
      - name: Store test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}
          path: coverage/
          retention-days: 30
  
  # ============================================================================
  # COVERAGE JOB
  # ============================================================================
  coverage:
    name: Check Test Coverage
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: test-results-unit
          path: ./coverage
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | grep -o '"lines".*"pct":[0-9.]*' | grep -o '[0-9.]*$' | head -1)
          echo "ðŸ“Š Test Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âš ï¸  Coverage below 80% threshold"
            exit 1
          fi
        continue-on-error: true
  
  # ============================================================================
  # PERFORMANCE JOB
  # ============================================================================
  performance:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./dist
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Run Lighthouse
        run: |
          npm install -g @lhci/cli@0.11.0 lighthouse
          lighthouse --chrome-flags="--headless --no-sandbox" http://localhost:3000 || true
        continue-on-error: true
      
      - name: Check bundle impact
        run: |
          if [ -d "dist" ]; then
            SIZE=$(du -sb dist | awk '{print $1}')
            SIZE_KB=$((SIZE / 1024))
            echo "ðŸ“¦ Bundle size: ${SIZE_KB}KB"
            if [ $SIZE_KB -gt 500 ]; then
              echo "âš ï¸  Bundle size warning: >500KB"
            fi
          fi
  
  # ============================================================================
  # SECURITY JOB
  # ============================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || true
      
      - name: Run security audit
        run: npm audit --production || true
        continue-on-error: true
      
      - name: Check for secrets
        run: |
          if grep -r "API_KEY\|password\|secret" src/ --exclude-dir=node_modules | grep -v "process.env"; then
            echo "âš ï¸  Potential secrets found in code"
            exit 1
          fi
        continue-on-error: true
  
  # ============================================================================
  # DEPLOY TO STAGING
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, quality, coverage, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./dist
      
      - name: Deploy to Vercel (Staging)
        run: |
          npm install -g vercel
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
      
      - name: Run smoke tests on staging
        run: |
          sleep 30  # Wait for deployment
          curl -f https://staging.example.com/health || exit 1
        continue-on-error: true
      
      - name: Notify deployment
        if: success()
        run: |
          echo "âœ… Deployed to staging"
  
  # ============================================================================
  # DEPLOY TO PRODUCTION
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, quality, coverage, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./dist
      
      - name: Deploy to Vercel (Production)
        run: |
          npm install -g vercel
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
      
      - name: Run smoke tests on production
        run: |
          sleep 30
          curl -f https://example.com/health || exit 1
        continue-on-error: true
      
      - name: Monitor production
        run: |
          echo "ðŸš€ Production deployment complete"
          echo "Monitoring performance metrics..."
      
      - name: Notify deployment
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ Production deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CodeGreen Production Deploy*\nâœ… Status: Successful\nðŸ“¦ Commit: ${{ github.sha }}\nðŸ‘¤ Author: ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  
  # ============================================================================
  # NOTIFY RESULTS
  # ============================================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build, test, quality]
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.build.result }}" == "failure" ]] || [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        if: always()
        with:
          payload: |
            {
              "text": "CodeGreen Pipeline Update",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Pipeline Result: ${{ steps.status.outputs.status }}*\nâœ… Build: ${{ needs.build.result }}\nâœ… Tests: ${{ needs.test.result }}\nâœ… Quality: ${{ needs.quality.result }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
