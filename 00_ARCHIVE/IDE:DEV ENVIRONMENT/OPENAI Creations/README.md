# antigravityCodeRed

**antigravityCodeRed** is your control system for wiring **Antigravity IDE**, LLM agents, GitHub, Supabase, and Vercel into a single, governed execution environment.

This repo is **the platform**, not a single feature app. It contains only:

- **Module 1 – Orchestration Brain**  
  The rules, roles, merge policy, safety rails, and workflows that govern how Antigravity and LLM agents are allowed to operate.
- **Module 2 – Infrastructure & Repo Skeleton**  
  The file/folder layout, integration points for Supabase, CI/CD pipelines for GitHub + Vercel, and secrets/env strategy.

Every future product you build — cashflow engine, legal war room, superseding‑indictment brain, Twilio marketing machine, closer bot, lead faucet, compliance engines, etc. — is a **SKU that plugs into this platform**, not a separate system.

---

## 1. What Problem This Solves

Without this system, letting an LLM/Antigravity touch your codebase looks like this:

> “Here’s my repo, here’s my keys, do something smart.”

That’s how you end up with:

- Random refactors in critical paths.
- Deleted or half‑migrated infrastructure.
- Broken deploys at 2 a.m.
- No clear policy around what is allowed vs forbidden.

**antigravityCodeRed** fixes that by giving you:

1. **A CONSTITUTION** (Module 1)
   - `docs/agent.md` – which agents exist, what they can and cannot do, and which directories they are allowed to touch.
   - `docs/orchestration.md` – how tasks move across agents (Plan → Code → Test → Review → Merge), and the rules for approval or rejection.
   - `docs/prompt-routing.md` – how the system interprets agent outputs and decides the next step.

2. **A MAP** (Module 2)
   - `docs/architecture.md` – how the repo is structured, which parts are legacy vs new, and where new code must be added.
   - A clear Red / Yellow / Green zone model for safe vs restricted areas.

3. **RAILS**
   - `.github/workflows/lint-test.yml` – enforce lint + test on every PR / push.
   - `.github/workflows/deploy-vercel.yml` – clean, repeatable Vercel deploys from `main` using secrets.
   - `.env.example` – single source of truth for required environment variables.

This works whether Antigravity is attached to a **brand‑new repo** or to a **repo that’s already 80% built** and messy.

---

## 2. Mental Model: Platform vs SKUs

You are not building “one app.” You are building a **Platform OS** that can host many SKUs.

### 2.1 Platform (This Repo)

The platform consists of:

- **Module 1 – Orchestration Brain (Docs + Optional Code)**  
  Lives in `docs/` and optional `src/orchestrator/`:
  - Defines all agents.
  - Defines merge rules (A/B/C/D/E).
  - Defines workflows and routing behavior.
  - Defines safety and escalation paths.

- **Module 2 – Infrastructure & Skeleton**  
  Lives in the repo root, `src/`, `.github/`, `lib/`:
  - Provides a consistent file/folder layout.
  - Wires in Supabase as the persistence layer.
  - Provides CI/CD for GitHub + Vercel.
  - Sets up secrets and env pattern.

Antigravity is told: “This repo’s docs and structure are the law. Obey them.”

### 2.2 SKUs (Future Build Targets)

The following are **not** defined here yet but are **explicitly expected** to plug in later:

- Cashflow & liquidity engine.
- Legal war room / war machine (dockets, motions, timelines, actors).
- FBI / superseding indictment analysis engine.
- Lead faucet / inbound conversion pipeline.
- Twilio marketing & outreach war machine.
- Closer bot for sales and retention.
- Compliance, chargeback rebuttal, and evidence engines.

All of those will live under `src/services/`, `src/api/`, and `src/ui/` using the same rules, same CI/CD, and same orchestration brain.

---

## 3. Repository Structure (Module 2 Skeleton)

Recommended baseline layout for `antigravityCodeRed`:

```text
antigravityCodeRed/
├── README.md
├── .env.example
├── docs/
│   ├── agent.md           # Agent roles, permissions, zones, rules
│   ├── orchestration.md   # Workflows, merge policy, task lifecycle
│   ├── architecture.md    # File structure, zones, strategy
│   └── prompt-routing.md  # How prompts & outputs are routed between agents
├── src/
│   ├── orchestrator/      # (Optional) concrete orchestration implementation
│   ├── services/          # Backend / domain services (future SKUs)
│   ├── api/               # API endpoints / serverless functions
│   └── ui/                # Frontend components / dashboards (if present)
├── agents/                # Agent prompt templates / configs (optional)
├── lib/                   # Shared libraries (logging, LLM utils, supabase client, etc.)
├── .github/
│   └── workflows/
│       ├── lint-test.yml
│       └── deploy-vercel.yml
├── package.json
└── tsconfig.json / jsconfig.json
```

**Key rules:**

- New code generated by Antigravity must be placed in the correct layer:
  - Infrastructure / orchestration → `src/orchestrator/`, `lib/`.
  - Backend services → `src/services/`.
  - HTTP/API layer → `src/api/`.
  - UI → `src/ui/`.
- No random top‑level folders. Everything goes through the platform design.

---

## 4. Module 1 – Orchestration Brain (Conceptual)

Module 1 is defined by four core documents in `docs/`:

- `agent.md` – defines **who** the agents are and **what** they’re allowed to do.
- `orchestration.md` – defines **how** the system coordinates tasks across agents.
- `prompt-routing.md` – defines **how** outputs from agents are interpreted and routed.
- `architecture.md` – defines **where** things live and which zones they belong to.

### 4.1 Agent Roles (High Level)

The details live in `docs/agent.md`, but at a glance the system expects:

- **ArchitectAgent** – designs solutions, proposes file changes, chooses patterns.
- **CodeWriterAgent** – writes and updates code according to architecture and zones.
- **TestAgent** – creates and executes tests; reports results.
- **ReviewAgent** – enforces A/B/C/D/E merge rules and checks diffs.
- **InfraAgent** – manages migrations, CI/CD, deployment concerns.
- **SafetyAgent** – detects dangerous operations (e.g., rewriting RED ZONE) and hard‑stops.

Later, you add product‑specific agents (e.g. LegalBrainAgent, CashflowBrainAgent) for SKUs, but always within these global constraints.

### 4.2 Merge Rules (A/B/C/D/E)

No change touches `main` unless it clearly satisfies **at least one** of:

- **A – Deployment:** Makes the system easier, safer, or faster to deploy.  
- **B – Revenue:** Increases revenue (or directly enables revenue‑generating behavior).  
- **C – Cost:** Reduces cost (execution, infra, maintenance, human time).  
- **D – Organization:** Improves structure/clarity (naming, layout, documentation).  
- **E – Legal:** Improves legal position (evidence, traceability, compliance, auditability).  

If a proposed change cannot be justified by A–E in the PR summary/comments → it is rejected or flagged for human review.

### 4.3 Workflow Overview

Typical chain for “implement X”:

1. **ArchitectAgent**: Reads the task, references every doc in `docs/`, and creates a plan.
2. **CodeWriterAgent**: Implements the plan strictly within allowed directories.
3. **TestAgent**: Adds/updates tests and runs them.
4. **ReviewAgent**: Validates code quality, structure, and A–E rules.
5. **InfraAgent**: Adjusts migrations and CI if needed, ensures no broken deploy.
6. PR is opened for human review; on approval and CI success, merged to `main`.

All of the logic, expectations, and step‑by‑step orchestration details live in `docs/orchestration.md` and `docs/prompt-routing.md`.

---

## 5. Module 2 – Infrastructure & Skeleton (Conceptual)

Module 2 makes sure the system doesn’t just “think” well; it **deploys** well.

### 5.1 Supabase Integration Points

The platform assumes Supabase is the default data plane:

- **Client‑side / public:**  
  - `NEXT_PUBLIC_SUPABASE_URL`  
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`  
- **Server‑side / admin:**  
  - `SUPABASE_SERVICE_KEY`

Typical pattern:

- `lib/supabaseClient.ts` – client for UI and public‑ish operations.
- `src/services/supabaseAdmin.ts` – service‑role client for admin logic, only used server‑side (API routes, orchestrator, background jobs).

Module 2 does **not** prescribe a specific schema yet, but sets up the patterns so future SKUs can rely on a consistent Supabase gateway instead of ad‑hoc instances everywhere.

### 5.2 CI/CD (GitHub Actions + Vercel)

Two primary workflow files live in `.github/workflows`:

- `lint-test.yml`
  - Runs on PR and pushes.
  - Installs dependencies (`npm ci`).
  - Runs linters (`npm run lint`) and tests (`npm test`).

- `deploy-vercel.yml`
  - Runs on `main` pushes.
  - Uses secrets: `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`.
  - Executes:
    - `vercel pull` (sync env from Vercel).
    - `vercel build --prod`.
    - `vercel deploy --prebuilt --prod`.

This is enough to guarantee:

- Every change is linted and tested.
- Every merge to `main` results in a deterministic deploy.

### 5.3 Secrets & Env Strategy

Baseline env variables (captured in `.env.example`):

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_KEY=

# Antigravity / LLM
AG_TOKEN=

# Vercel
VERCEL_TOKEN=
VERCEL_ORG_ID=
VERCEL_PROJECT_ID=

# GitHub (if needed for API usage)
GITHUB_TOKEN=
```

Rules:

- **Local dev**: copy `.env.example` → `.env.local` and fill in real values; never commit `.env.local`.
- **GitHub Actions**: configure secrets under repo settings → Secrets and variables.
- **Vercel**: add required env vars in the project’s Settings → Environment Variables; use `vercel env pull` to sync to local when needed.

---

## 6. Greenfield vs Brownfield Setup

antigravityCodeRed must handle both scenarios cleanly.

### 6.1 Greenfield (New Project)

If you are starting from scratch:

1. **Create repo & clone**  
   ```bash
   git init antigravityCodeRed
   cd antigravityCodeRed
   ```

2. **Drop in this structure**  
   - Save this `README.md` at repo root.
   - Add `docs/` with the four core docs.
   - Add basic `src/`, `lib/`, `.github/workflows`, `.env.example`.

3. **Install dependencies**  
   ```bash
   npm init -y
   # add your framework here; e.g. Next.js, Express, etc.
   # npm install next react react-dom @supabase/supabase-js ...
   ```

4. **Create Supabase & Vercel projects**  
   - Create Supabase project → copy URL + keys into `.env.local` and Vercel env.
   - Create Vercel project → link to this repo; set env vars; create `VERCEL_*` secrets in GitHub.

5. **Point Antigravity at repo**  
   - Open Antigravity IDE.
   - Load this repo as a project.
   - In your system prompt for Antigravity, instruct:
     - “Read all files in `docs/` and obey them as the project constitution.”

6. **Run first test task**  
   - Example: “Add a `/health` API endpoint and tests.”
   - Verify:  
     - Code lands in correct directories.  
     - CI passes.  
     - Deploy completes.

Now Modules 1 & 2 are live on a clean slate.

### 6.2 Brownfield (Existing 80% Done Repo)

If Antigravity is joining an already messy, 80% built project, you **must** do this carefully.

#### Step 1 – Tag Current State

Before you add anything:

```bash
git tag pre-antigravity
git push --tags
```

This gives you a hard restore point: take it seriously.

#### Step 2 – Add Platform Docs & Workflows

Add the following, either by copy/paste or via file imports:

- `README.md` (this file, adapted to your repo name).
- `docs/agent.md`, `docs/orchestration.md`, `docs/architecture.md`, `docs/prompt-routing.md`.
- `.github/workflows/lint-test.yml`, `.github/workflows/deploy-vercel.yml`.
- `.env.example`.

Commit this as something like:

```bash
git add README.md docs .github .env.example
git commit -m "Add antigravityCodeRed platform docs and CI skeleton"
```

#### Step 3 – Document the REAL Architecture

Open `docs/architecture.md` and **tell the truth** about your current repo:

- Where are the main apps / services?
- Which directories are effectively “do not touch, too fragile”?
- Where do you want new work to land from now on?

You will explicitly mark directories as:

- **RED ZONE** – protected; only touched on explicit, narrow tasks.  
- **YELLOW ZONE** – modifiable but with caution, tests required, stable interfaces preferred.  
- **GREEN ZONE** – preferred area for new work; safe to build new SKUs and scaffolding.

#### Step 4 – Establish Zone Rules in agent/orchestration Docs

In `docs/agent.md` and `docs/orchestration.md` you will list:

- For each agent:
  - Which zones it may operate in.
  - When it must escalate or refuse.
- For the orchestrator:
  - “Never let CodeWriterAgent edit RED ZONE unless the task explicitly says so.”
  - “Prefer adding new modules in GREEN ZONE even if legacy code exists elsewhere.”

#### Step 5 – Hook Up CI/CD and Secrets

- Configure GitHub secrets (`VERCEL_*`, `SUPABASE_SERVICE_KEY`, `AG_TOKEN`, etc.).
- Ensure Vercel project is linked and env vars are in place.
- Run `npm ci && npm run lint && npm test` locally at least once to see baseline failures.

#### Step 6 – Instruct Antigravity

Your first Antigravity prompt for this repo should look like:

> 1. Read `README.md` and all files in `docs/`.  
> 2. Understand RED / YELLOW / GREEN zones from `docs/architecture.md`.  
> 3. Confirm you will not modify RED ZONE code without explicit, narrow instructions.  
> 4. Only propose changes that satisfy at least one of A/B/C/D/E (merge rules).  
> 5. Work only on a feature branch and open a PR, do not merge yourself.

#### Step 7 – Start With Trivial, Non‑Risk Tasks

Examples:

- Add documentation in `docs/` or `src/ui` (GREEN ZONE).
- Add a `/health` endpoint.
- Add tests around an existing non‑critical module.

You do **not** start by letting it “clean up the whole repo.” You let it earn that trust.

---

## 7. Day‑to‑Day Workflow With antigravityCodeRed

### 7.1 Human Loop

Your loop:

1. Define a task (issue, note, or spoken prompt).
2. Create a branch or let Antigravity create one following naming rules.
3. Let Antigravity run a workflow (Plan → Code → Test → Review).
4. You review the PR; if satisfied and CI passes, merge to `main`.

### 7.2 Antigravity / Agent Loop (High Level)

1. Receive task description.
2. ArchitectAgent synthesizes plan, referencing docs.
3. CodeWriterAgent implements in GREEN/YELLOW zones.
4. TestAgent writes/updates tests and runs them.
5. ReviewAgent checks diffs, A–E rules, and zones.
6. InfraAgent updates migrations / CI if needed.
7. PR created for human review.

At no point should any agent directly push to `main` without a PR / review gate, unless you explicitly configure that behavior for trivial branches (not recommended here).

---

## 8. Conventions & Policies

### 8.1 Branching

- `main` – production branch (auto‑deployed).
- `develop` – optional staging branch.
- Feature branches: `feature/<sku>-<short-description>`.
- Fix branches: `fix/<area>-<short-description>`.

### 8.2 Commit Messages

- Brief but meaningful (`feat: add health endpoint`, `fix: correct supabase client import`, etc.).
- Use prefixes like `feat:`, `fix:`, `chore:`, `docs:`, `refactor:` for clarity.

### 8.3 Coding Standards

- Prefer TypeScript if using a JS stack.
- Single unified ESLint + Prettier configuration.
- No hard‑coded secrets; all secrets must come from env.

---

## 9. What To Build Next (Once Modules 1 & 2 Are Live)

Once this platform is in place and validated, you will:

- Add a **Cashflow SKU** to track liquidity, obligations, and “what if I delay X by 7 days?”.
- Add a **Legal War Room SKU** to house cases, motions, deadlines, actors, and filings.
- Add an **FBI / Superseding Indictment SKU** to track FDIC/DOJ/FBI behavior patterns and generate legal strategy.
- Add a **Lead Faucet / Twilio War Machine SKU** to manage outreach, RCS/SMS/email flows, and conversion KPIs.
- Add a **Closer Bot SKU** for scripted, dynamic, and compliant closes.

All of those get built **inside this repo**, using the same agents, same docs, same CI/CD, and same secrets patterns defined here.

The rest of the system will evolve, but **antigravityCodeRed is the spine**.  
Do not skip it. Do not bypass it. Everything goes through this.

---

## 10. Quick Setup Checklist

For fast execution, here’s your brutal checklist:

- [ ] Create or open repo.
- [ ] Add this `README.md`.
- [ ] Add `docs/` with four core docs (agent, orchestration, architecture, prompt‑routing).
- [ ] Add `.github/workflows` with lint/test + deploy pipelines.
- [ ] Add `.env.example` and set GitHub + Vercel secrets.
- [ ] Tag current state if onboarding a half‑done repo.
- [ ] Open in Antigravity and command it to read + obey docs.
- [ ] Run one full cycle: Plan → Code → Test → Review → Deploy on a **tiny** feature.
- [ ] Only then, start building SKUs on top.

If it doesn’t go through antigravityCodeRed, it doesn’t go into your system. Period.
